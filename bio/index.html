<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Examens biologiques ‚Äì S√©lecteur v2.2</title>
  <style>
    :root {
      /* Palette align√©e sur PCA Soins Palliatifs */
      --primary: #1e3a8a;
      --primary-dark: #1e2d6b;
      --primary-light: #dbeafe;
      --primary-xlight: #eff6ff;
      --generic: #1e3a8a;
      --generic-light: #bfdbfe;
      --generic-xlight: #eff6ff;
      --patho: #0369a1;
      --patho-light: #bae6fd;
      --patho-xlight: #f0f9ff;
      --amber: #b45309;
      --amber-light: #fef3c7;
      --border: #e5e7eb;
      --text: #111827;
      --text-muted: #6b7280;
      --bg: #fafafa;
      --white: #ffffff;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.07);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.09);
      --shadow-lg: 0 8px 32px rgba(0,0,0,0.13);
      --radius: 12px;
      --radius-sm: 10px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body {
      min-height: 100vh;
      background: var(--bg);
    }
    html, body, button, input, select, textarea {
      font-family: "Times New Roman", Times, serif;
      font-size: 12pt;
      color: var(--text);
    }

    /* ‚îÄ‚îÄ HEADER ‚Äì style PCA ‚îÄ‚îÄ */
    .app-header {
      background: var(--white);
      border-bottom: 2px solid var(--text);
      padding: 14px 28px;
      display: flex;
      align-items: baseline;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .app-header h1 {
      font-size: 14pt;
      font-weight: 700;
      letter-spacing: .04em;
      text-transform: uppercase;
      color: var(--text);
    }
    .version-badge {
      background: #374151;
      color: #fff;
      padding: 2px 10px;
      border-radius: 20px;
      font-size: 8.5pt;
      font-weight: 700;
      letter-spacing: .05em;
    }
    .header-date {
      margin-left: auto;
      font-size: 9pt;
      color: var(--text-muted);
      font-style: italic;
    }

    /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
    .app-body {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 0;
      max-width: 1440px;
      margin: 0 auto;
      min-height: calc(100vh - 62px);
    }

    /* ‚îÄ‚îÄ LEFT PANEL ‚îÄ‚îÄ */
    .left-panel {
      padding: 24px 24px 24px 28px;
      overflow-y: auto;
    }

    /* ‚îÄ‚îÄ SECTION LABELS ‚îÄ‚îÄ */
    .section-label {
      font-size: 8.5pt;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: #374151;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #d1d5db;
    }

    /* ‚îÄ‚îÄ PICKS GRID (deux colonnes) ‚îÄ‚îÄ */
    .picks-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 28px;
      align-items: start;
    }

    .picks-col {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: 0 1px 3px #0001;
      overflow: hidden;
      border: 1px solid #e5e7eb;
    }

    .picks-col-header {
      padding: 12px 16px;
      font-weight: 700;
      font-size: 10.5pt;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .picks-col-header.generic {
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
      color: #fff;
      border-bottom: none;
    }
    .picks-col-header.patho {
      background: linear-gradient(135deg, #0369a1 0%, #0891b2 100%);
      color: #fff;
      border-bottom: none;
    }

    .picks-list {
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pick-btn {
      width: 100%;
      padding: 9px 14px;
      border: 1.5px solid transparent;
      border-radius: var(--radius-sm);
      font-size: 10.5pt;
      font-weight: 600;
      cursor: pointer;
      text-align: left;
      transition: all 0.18s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: unset;
      height: auto;
    }

    .pick-btn.generic {
      background: #eff6ff;
      color: #1e3a8a;
      border-color: #bfdbfe;
    }
    .pick-btn.generic:hover {
      background: #dbeafe;
      border-left-color: #1e3a8a;
      border-left-width: 3px;
      transform: translateX(3px);
    }
    .pick-btn.patho {
      background: #f0f9ff;
      color: #0369a1;
      border-color: #bae6fd;
    }
    .pick-btn.patho:hover {
      background: #e0f2fe;
      border-left-color: #0369a1;
      border-left-width: 3px;
      transform: translateX(3px);
    }

    .pick-btn.added {
      background: #dbeafe !important;
      color: #1e3a8a !important;
      border-color: #2563eb !important;
    }

    .pick-count {
      font-size: 9pt;
      font-weight: 400;
      opacity: 0.7;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ ADVANCED SECTION (repliable) ‚îÄ‚îÄ */
    .advanced-toggle {
      width: 100%;
      padding: 10px 16px;
      background: var(--white);
      border: 1px solid #d1d5db;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 10.5pt;
      font-weight: 700;
      color: #374151;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
      margin-bottom: 0;
    }
    .advanced-toggle:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    .advanced-toggle .toggle-arrow {
      margin-left: auto;
      transition: transform 0.3s ease;
      font-size: 10pt;
    }
    .advanced-toggle.open .toggle-arrow {
      transform: rotate(180deg);
    }

    .advanced-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }
    .advanced-panel.open {
      max-height: 2000px;
    }
    .advanced-inner {
      padding-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Recherche */
    .search-box {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .search-box-header {
      padding: 10px 16px;
      font-weight: 700;
      font-size: 10.5pt;
      color: #1e3a8a;
      background: #eff6ff;
      border-bottom: 1px solid #bfdbfe;
    }
    .search-box-body {
      padding: 12px 16px;
    }
    input[type="search"] {
      width: 100%;
      padding: 9px 13px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 11pt;
      color: var(--text);
      background: var(--bg);
      transition: all 0.2s;
    }
    input[type="search"]:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 1px;
      background: var(--white);
    }
    .search-results {
      margin-top: 8px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--white);
      max-height: 260px;
      overflow-y: auto;
      display: none;
    }
    .search-result-item {
      padding: 9px 13px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background 0.15s;
    }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: var(--primary-light); }
    .search-result-name { font-weight: 500; font-size: 10.5pt; }
    .search-result-cat { font-size: 9pt; color: var(--text-muted); font-style: italic; }
    .no-results { padding: 16px; text-align: center; color: var(--text-muted); font-style: italic; font-size: 10pt; }

    /* Accord√©on */
    .accordion {
      background: var(--white);
      border: 1.5px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .accordion-item { border-bottom: 1px solid var(--border); }
    .accordion-item:last-child { border-bottom: none; }
    .accordion-header {
      padding: 12px 16px;
      cursor: pointer;
      background: #f9fafb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 10.5pt;
      color: #1e3a8a;
      user-select: none;
      transition: background 0.15s;
    }
    .accordion-header:hover { background: #eff6ff; }
    .accordion-header.active { background: #dbeafe; border-bottom: 2px solid #1e3a8a; }
    .accordion-icon { transition: transform 0.3s ease; font-size: 11pt; }
    .accordion-header.active .accordion-icon { transform: rotate(180deg); }
    .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .accordion-content.active { max-height: 800px; overflow-y: auto; }
    .accordion-body { padding: 12px 16px; }
    .cat-actions { display: flex; gap: 8px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border); }
    .cat-actions button {
      padding: 5px 11px;
      font-size: 9.5pt;
      width: auto;
      height: auto;
      min-height: unset;
      background: var(--white);
      color: #1e3a8a;
      border: 1px solid #bfdbfe;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s;
    }
    .cat-actions button:hover { background: var(--primary-light); }
    .exam-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 4px; }
    .exam-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
    .exam-item:hover { background: #f3f4f6; }
    .exam-item input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--primary); flex-shrink: 0; }
    .exam-item label { font-size: 10.5pt; font-weight: 400; cursor: pointer; flex: 1; }

    /* Examen personnalis√© */
    .custom-box {
      background: var(--white);
      border: 1.5px solid #fcd34d;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
    }
    .custom-box-header {
      padding: 10px 16px;
      font-weight: 700;
      font-size: 10.5pt;
      color: #92400e;
      background: #fef3c7;
      border-bottom: 1px solid #fcd34d;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .custom-box-body { padding: 12px 16px; display: grid; gap: 8px; }
    .custom-box-body input,
    .custom-box-body select {
      width: 100%;
      padding: 8px 12px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 10.5pt;
      background: var(--bg);
      transition: all 0.2s;
    }
    .custom-box-body input:focus,
    .custom-box-body select:focus {
      outline: none;
      border-color: var(--amber);
      box-shadow: 0 0 0 3px var(--amber-light);
    }
    .custom-box-body button {
      padding: 9px 16px;
      background: #b45309;
      color: #fff;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: 10.5pt;
      cursor: pointer;
      transition: all 0.2s;
      height: auto;
      min-height: unset;
    }
    .custom-box-body button:hover { background: #b45309; }

    /* ‚îÄ‚îÄ RIGHT PANEL ‚Äî PANIER ‚îÄ‚îÄ */
    .basket-panel {
      background: var(--white);
      border-left: 2px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 62px;
      height: calc(100vh - 62px);
    }

    .basket-head {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
    }
    .basket-head h2 {
      font-size: 13pt;
      font-weight: 700;
      color: #fff;
      flex: 1;
      letter-spacing: .03em;
    }
    .basket-counter {
      background: #ffffff30;
      color: #fff;
      font-weight: 800;
      font-size: 11pt;
      padding: 4px 12px;
      border-radius: 20px;
      min-width: 36px;
      text-align: center;
      border: 1px solid #ffffff50;
    }

    .basket-body {
      flex: 1;
      overflow-y: auto;
      padding: 14px 16px;
    }

    .basket-empty {
      padding: 40px 20px;
      text-align: center;
      color: #9ca3af;
      font-size: 10.5pt;
      font-style: italic;
      line-height: 1.6;
    }
    .basket-empty .empty-icon { font-size: 32pt; display: block; margin-bottom: 12px; opacity: 0.3; }

    .basket-group { margin-bottom: 14px; }
    .basket-group-title {
      font-size: 9pt;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: #1e3a8a;
      padding: 5px 8px;
      background: #eff6ff;
      border-left: 3px solid #2563eb;
      border-radius: 0 4px 4px 0;
      margin-bottom: 5px;
    }
    .basket-exam {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      margin-bottom: 3px;
      background: #f9fafb;
      border-radius: 6px;
      transition: background 0.15s;
    }
    .basket-exam:hover { background: #fee2e2; cursor: default; }
    .basket-exam.duplicate {
      background: #fefce8;
      border-left: 3px solid #ca8a04;
    }
    .basket-exam.duplicate:hover { background: #fef9c3; }
    .duplicate-badge {
      font-size: 8pt;
      font-weight: 700;
      color: #92400e;
      background: #fef3c7;
      border: 1px solid #fcd34d;
      border-radius: 4px;
      padding: 1px 5px;
      margin-right: 4px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .basket-exam-name { flex: 1; font-size: 10pt; }
    .basket-exam-remove {
      background: transparent;
      border: none;
      color: #dc2626;
      cursor: pointer;
      font-size: 13pt;
      line-height: 1;
      padding: 0 2px;
      transition: color 0.15s;
      flex-shrink: 0;
    }
    .basket-exam-remove:hover { color: #991b1b; }

    .basket-foot {
      padding: 14px 16px;
      border-top: 2px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: var(--white);
    }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn {
      width: 100%;
      padding: 11px 16px;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: 10.5pt;
      cursor: pointer;
      border: 1.5px solid transparent;
      transition: all 0.2s;
      text-align: center;
      min-height: unset;
      height: auto;
      display: block;
    }
    .btn-primary { background: #111827; color: #fff; border-color: #11182720; }
    .btn-primary:hover { opacity: .85; }
    .btn-secondary { background: #fff; color: #111827; border-color: #d1d5db; }
    .btn-secondary:hover { background: #f3f4f6; }
    .btn-danger { background: #dc2626; color: var(--white); border-color: #dc2626; }
    .btn-danger:hover { background: #991b1b; }
    .btn-sm { padding: 8px 14px; font-size: 10pt; }

    /* ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ */
    .preview-section {
      margin: 0 28px 28px;
    }
    .preview-label {
      font-size: 8.5pt;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .preview-label::after { content: ''; flex: 1; height: 1px; background: var(--border); }
    .preview-box {
      background: var(--white);
      border: 1px solid #e5e7eb;
      border-radius: var(--radius);
      padding: 18px 20px;
      line-height: 1.4;
      white-space: pre-wrap;
      font-size: 12pt;
      min-height: 80px;
      box-shadow: 0 1px 3px #0001;
      outline: none;
      transition: outline 0.2s;
    }
    .preview-box:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 1px;
    }
    .preview-editable-hint {
      font-size: 9pt;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .muted-note {
      margin: 12px 28px 0;
      font-size: 9.5pt;
      color: var(--text-muted);
      font-style: italic;
    }

    /* version history */
    .version-history {
      margin: 16px 28px 28px;
      padding: 12px 16px;
      background: #f3f4f6;
      border-radius: var(--radius-sm);
      font-size: 9pt;
      color: var(--text-muted);
    }
    .version-history strong { color: #374151; }

    .hidden { position: absolute; left: -9999px; top: -9999px; opacity: 0; }
    #richSource { font-family: "Times New Roman", Times, serif; font-size: 12pt; line-height: 1.4; }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 1100px) {
      .app-body { grid-template-columns: 1fr; }
      .basket-panel { position: static; height: auto; border-left: none; border-top: 2px solid var(--border); }
      .picks-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .left-panel { padding: 16px; }
      .app-header { padding: 12px 16px; }
      .app-header h1 { font-size: 11pt; }
    }

    /* animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .left-panel { animation: fadeIn 0.4s ease; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header">
    <h1>Examens biologiques ‚Äì S√©lecteur</h1>
    <span class="version-badge">v2.2</span>
    <span class="header-date">Mars 2026</span>
  </header>

  <div class="app-body">

    <!-- PANNEAU GAUCHE -->
    <div class="left-panel">

      <!-- PICKS GRID -->
      <p class="section-label">S√©lection rapide</p>
      <div class="picks-grid">

        <!-- Bilans g√©n√©riques -->
        <div class="picks-col">
          <div class="picks-col-header generic">üìã Bilans g√©n√©riques</div>
          <div class="picks-list" id="genericsList"></div>
        </div>

        <!-- Packages pathologies -->
        <div class="picks-col">
          <div class="picks-col-header patho">‚ö° Packages pathologies</div>
          <div class="picks-list" id="pathosList"></div>
        </div>

      </div>

      <!-- SECTION AVANC√âE -->
      <button class="advanced-toggle" id="advancedToggle">
        <span>üîç</span>
        <span>Recherche avanc√©e &amp; examen personnalis√©</span>
        <span class="toggle-arrow">‚ñº</span>
      </button>

      <div class="advanced-panel" id="advancedPanel">
        <div class="advanced-inner">

          <!-- Recherche -->
          <div class="search-box">
            <div class="search-box-header">üîç Recherche dans le catalogue</div>
            <div class="search-box-body">
              <input type="search" id="globalSearch" placeholder="Rechercher un examen (ex: NFS, HbA1c, cr√©atinine...)">
              <div id="searchResults" class="search-results"></div>
            </div>
          </div>

          <!-- Accord√©on cat√©gories -->
          <div class="accordion" id="accordion"></div>

          <!-- Examen personnalis√© -->
          <div class="custom-box">
            <div class="custom-box-header">‚ûï Ajouter un examen non r√©pertori√©</div>
            <div class="custom-box-body">
              <input type="text" id="customExamName" placeholder="Nom de l'examen">
              <select id="customExamCategory">
                <option value="">-- Choisir une cat√©gorie --</option>
              </select>
              <button id="addCustomExam">Ajouter au panier</button>
            </div>
          </div>

        </div>
      </div>

    </div><!-- /left-panel -->

    <!-- PANIER SIDEBAR -->
    <aside class="basket-panel">
      <div class="basket-head">
        <h2>üóÇÔ∏è Panier</h2>
        <span class="basket-counter" id="basketCounter">0</span>
      </div>

      <div class="basket-body" id="basketItems">
        <div class="basket-empty">
          <span class="empty-icon">üß™</span>
          Aucun examen s√©lectionn√©.<br>
          Utilisez les bilans ou packages ci-contre.
        </div>
      </div>

      <div class="basket-foot">
        <button class="btn btn-primary" id="generate">G√©n√©rer le texte</button>
        <button class="btn btn-secondary btn-sm" id="copy">Copier (texte brut)</button>
        <button class="btn btn-secondary btn-sm" id="copyRich">Copier avec mise en forme</button>
        <button class="btn btn-danger btn-sm" id="clearBasket">Vider le panier</button>
      </div>
    </aside>

  </div><!-- /app-body -->

  <!-- PREVIEW (pleine largeur) -->
  <div style="max-width:1440px;margin:0 auto;">
    <div id="previewSection" class="preview-section" style="display:none;">
      <p class="preview-label">Aper√ßu du texte g√©n√©r√©</p>
      <div id="preview" class="preview-box" contenteditable="true" spellcheck="false" aria-label="Texte g√©n√©r√© ‚Äî modifiable avant copie"></div>
      <p class="preview-editable-hint">‚úèÔ∏è Texte modifiable directement ‚Äî les modifications seront conserv√©es lors de la copie.</p>
    </div>

    <p class="muted-note">NB : texte compatible Export Domilink (sans puces ni tableau). Copie riche conserve le gras et les retours √† la ligne.</p>

    <div class="version-history">
      <strong>üìã Historique des versions :</strong><br>
      <span style="color:#1e3a8a;font-weight:700;">v2.2</span> (Mars 2026) ‚Äî Refonte ergonomique : bilans g√©n√©riques + section avanc√©e repliable<br>
      <span>v2.1</span> (25/11/2025) ‚Äî Bilans nutrition artificielle/parent√©rale + pr√©albumine<br>
      <span>v2.0</span> (10/11/2025) ‚Äî Syst√®me panier + QuickPick + Recherche globale
    </div>
  </div>

  <textarea id="plain" readonly class="hidden"></textarea>
  <div id="richSource" class="hidden"></div>

<script>
(function () {
  'use strict';

  const el = id => document.getElementById(id);

  // ============================================================
  // CATALOGUE
  // ============================================================
  const CATALOG = {
    "Examens de base (bilan standard)": [
      "NFS",
      "Ionogramme sanguin (Na, K, Cl, HCO3-)",
      "Cr√©atinine",
      "Ur√©e",
      "DFG estim√© (CKD-EPI)",
      "Glyc√©mie √† jeun",
      "Bilan h√©patique (ASAT, ALAT, PAL, GGT, bilirubine)",
      "Prot√©ines totales",
      "Albumine",
      "Pr√©albumine",
      "CRP",
      "VS"
    ],
    "H√©matologie": [
      "NFS + frottis",
      "R√©ticulocytes",
      "TP/INR",
      "TCA",
      "Fibrinog√®ne",
      "D-dim√®res",
      "Ferritine",
      "Fer s√©rique",
      "Transferrine / CST",
      "√âlectrophor√®se des prot√©ines"
    ],
    "Vitamines / Min√©raux": [
      "Vitamine B12",
      "Folates",
      "Vitamine D (25-OH)",
      "Calc√©mie",
      "Phosphor√©mie",
      "Magn√©s√©mie"
    ],
    "Cardiologie / Vasculaire": [
      "Troponine ultrasensible",
      "BNP ou NT-proBNP",
      "Cholest√©rol total",
      "HDL",
      "LDL",
      "Triglyc√©rides",
      "HbA1c",
      "Bilan de coagulation (TP, TCA, fibrinog√®ne)"
    ],
    "Endocrinologie / M√©tabolisme": [
      "TSH",
      "T3 libre",
      "T4 libre",
      "Cortisol√©mie",
      "ACTH",
      "Prolactine",
      "FSH",
      "LH",
      "≈ístradiol",
      "Testost√©rone",
      "Insulin√©mie",
      "Peptide C"
    ],
    "Pneumologie": [
      "Gaz du sang art√©riel (pH, PaCO2, PaO2, HCO3-, SaO2)",
      "Procalcitonine"
    ],
    "Infectiologie": [
      "H√©mocultures",
      "ECBU",
      "Coproculture",
      "Pr√©l√®vements locaux",
      "S√©rologie VIH",
      "S√©rologie VHB",
      "S√©rologie VHC",
      "S√©rologie syphilis",
      "S√©rologie EBV",
      "S√©rologie CMV",
      "S√©rologie toxoplasmose",
      "PCR respiratoires (SARS-CoV-2, grippe)",
      "PCR Clostridioides difficile",
      "Leucocytes"
    ],
    "N√©phrologie": [
      "Ionogramme urinaire",
      "Prot√©inurie",
      "Albuminurie",
      "Micro-albuminurie",
      "Acide urique"
    ],
    "Gyn√©cologie / Obst√©trique": [
      "Œ≤-hCG",
      "Progest√©rone",
      "Bilan infectieux grossesse (toxoplasmose, rub√©ole, syphilis, VIH, VHB, VHC)",
      "Groupage ABO-Rh",
      "RAI"
    ],
    "H√©pato-Gastro-Ent√©rologie": [
      "ASAT",
      "ALAT",
      "PAL",
      "GGT",
      "Bilirubine totale et conjugu√©e",
      "Facteur V",
      "Amylase",
      "Lipase",
      "Ammoni√©mie",
      "S√©rologie h√©patites (A, B, C, E)"
    ],
    "Rhumatologie / Inflammation": [
      "Facteur rhumato√Øde",
      "Anti-CCP",
      "ANA",
      "Anti-DNA",
      "ENA",
      "HLA-B27"
    ],
    "Diab√©tologie / Nutrition": [
      "Glyc√©mie post-prandiale",
      "Bilan lipidique (CT, HDL, LDL, TG)",
      "Fonction r√©nale (cr√©atinine, DFG)",
      "√âlectrolytes",
      "Magn√©sium",
      "Phosphore"
    ],
    "Urologie / Andrologie": [
      "PSA total",
      "PSA libre",
      "Cytologie urinaire"
    ],
    "Oncologie": [
      "LDH",
      "Œ≤2-microglobuline",
      "CEA",
      "CA 19-9",
      "AFP",
      "CA-125",
      "CA 15-3",
      "NSE"
    ],
    "Toxicologie / Pharmacologie": [
      "Alcool√©mie",
      "Benzodiaz√©pines (d√©pistage)",
      "Opiac√©s (d√©pistage)",
      "Cannabis (d√©pistage)",
      "Coca√Øne (d√©pistage)",
      "Valproate (dosage)",
      "Carbamaz√©pine (dosage)",
      "Digoxine (dosage)",
      "Lithium (dosage)",
      "Tacrolimus (dosage)",
      "Ciclosporine (dosage)",
      "Fonction h√©patique",
      "Fonction r√©nale"
    ]
  };

  // ============================================================
  // BILANS G√âN√âRIQUES
  // ============================================================
  const GENERICS = {
    standard: {
      name: "Bilan standard",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "NFS" },
        { cat: "Examens de base (bilan standard)", exam: "Ionogramme sanguin (Na, K, Cl, HCO3-)" },
        { cat: "Examens de base (bilan standard)", exam: "Cr√©atinine" },
        { cat: "Examens de base (bilan standard)", exam: "DFG estim√© (CKD-EPI)" },
        { cat: "Examens de base (bilan standard)", exam: "Glyc√©mie √† jeun" },
        { cat: "Examens de base (bilan standard)", exam: "CRP" }
      ]
    },
    renal: {
      name: "Bilan r√©nal",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "Cr√©atinine" },
        { cat: "Examens de base (bilan standard)", exam: "DFG estim√© (CKD-EPI)" },
        { cat: "Examens de base (bilan standard)", exam: "Ionogramme sanguin (Na, K, Cl, HCO3-)" },
        { cat: "Examens de base (bilan standard)", exam: "Ur√©e" },
        { cat: "N√©phrologie", exam: "Prot√©inurie" },
        { cat: "N√©phrologie", exam: "Micro-albuminurie" }
      ]
    },
    hepatique: {
      name: "Bilan h√©patique",
      exams: [
        { cat: "H√©pato-Gastro-Ent√©rologie", exam: "ASAT" },
        { cat: "H√©pato-Gastro-Ent√©rologie", exam: "ALAT" },
        { cat: "H√©pato-Gastro-Ent√©rologie", exam: "PAL" },
        { cat: "H√©pato-Gastro-Ent√©rologie", exam: "GGT" },
        { cat: "H√©pato-Gastro-Ent√©rologie", exam: "Bilirubine totale et conjugu√©e" },
        { cat: "H√©matologie", exam: "TP/INR" },
        { cat: "Examens de base (bilan standard)", exam: "Albumine" }
      ]
    },
    urinaire: {
      name: "Bilan urinaire",
      exams: [
        { cat: "Infectiologie", exam: "ECBU" },
        { cat: "N√©phrologie", exam: "Ionogramme urinaire" },
        { cat: "N√©phrologie", exam: "Prot√©inurie" },
        { cat: "Urologie / Andrologie", exam: "Cytologie urinaire" }
      ]
    },
    coagulation: {
      name: "Bilan coagulation",
      exams: [
        { cat: "H√©matologie", exam: "TP/INR" },
        { cat: "H√©matologie", exam: "TCA" },
        { cat: "H√©matologie", exam: "Fibrinog√®ne" },
        { cat: "H√©matologie", exam: "D-dim√®res" }
      ]
    },
    nutritionnel: {
      name: "Bilan nutritionnel",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "Albumine" },
        { cat: "Examens de base (bilan standard)", exam: "Pr√©albumine" },
        { cat: "Examens de base (bilan standard)", exam: "Ionogramme sanguin (Na, K, Cl, HCO3-)" },
        { cat: "Vitamines / Min√©raux", exam: "Magn√©s√©mie" },
        { cat: "Vitamines / Min√©raux", exam: "Phosphor√©mie" },
        { cat: "Vitamines / Min√©raux", exam: "Calc√©mie" }
      ]
    },
    lipidique: {
      name: "Bilan lipidique",
      exams: [
        { cat: "Cardiologie / Vasculaire", exam: "Cholest√©rol total" },
        { cat: "Cardiologie / Vasculaire", exam: "HDL" },
        { cat: "Cardiologie / Vasculaire", exam: "LDL" },
        { cat: "Cardiologie / Vasculaire", exam: "Triglyc√©rides" },
        { cat: "Examens de base (bilan standard)", exam: "Glyc√©mie √† jeun" }
      ]
    }
  };

  // ============================================================
  // PACKAGES PATHOLOGIES
  // ============================================================
  const PATHOS = {
    diabete: {
      name: "Diab√®te",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "Glyc√©mie √† jeun" },
        { cat: "Cardiologie / Vasculaire", exam: "HbA1c" },
        { cat: "Examens de base (bilan standard)", exam: "Cr√©atinine" },
        { cat: "Examens de base (bilan standard)", exam: "DFG estim√© (CKD-EPI)" },
        { cat: "N√©phrologie", exam: "Micro-albuminurie" },
        { cat: "Cardiologie / Vasculaire", exam: "Cholest√©rol total" },
        { cat: "Cardiologie / Vasculaire", exam: "LDL" },
        { cat: "Cardiologie / Vasculaire", exam: "Triglyc√©rides" }
      ]
    },
    greffe: {
      name: "Greffe r√©nale",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "Cr√©atinine" },
        { cat: "Examens de base (bilan standard)", exam: "DFG estim√© (CKD-EPI)" },
        { cat: "Examens de base (bilan standard)", exam: "Ionogramme sanguin (Na, K, Cl, HCO3-)" },
        { cat: "Examens de base (bilan standard)", exam: "NFS" },
        { cat: "Toxicologie / Pharmacologie", exam: "Tacrolimus (dosage)" },
        { cat: "Toxicologie / Pharmacologie", exam: "Ciclosporine (dosage)" },
        { cat: "Examens de base (bilan standard)", exam: "CRP" }
      ]
    },
    insuffisance: {
      name: "Insuff. cardiaque",
      exams: [
        { cat: "Cardiologie / Vasculaire", exam: "BNP ou NT-proBNP" },
        { cat: "Cardiologie / Vasculaire", exam: "Troponine ultrasensible" },
        { cat: "Examens de base (bilan standard)", exam: "Ionogramme sanguin (Na, K, Cl, HCO3-)" },
        { cat: "Examens de base (bilan standard)", exam: "Cr√©atinine" },
        { cat: "Examens de base (bilan standard)", exam: "DFG estim√© (CKD-EPI)" },
        { cat: "Examens de base (bilan standard)", exam: "NFS" }
      ]
    },
    infectieux: {
      name: "Synd. infectieux",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "CRP" },
        { cat: "Pneumologie", exam: "Procalcitonine" },
        { cat: "Examens de base (bilan standard)", exam: "NFS" },
        { cat: "Infectiologie", exam: "H√©mocultures" },
        { cat: "Infectiologie", exam: "ECBU" }
      ]
    },
    preop: {
      name: "Bilan pr√©-op√©ratoire",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "NFS" },
        { cat: "H√©matologie", exam: "TP/INR" },
        { cat: "H√©matologie", exam: "TCA" },
        { cat: "Examens de base (bilan standard)", exam: "Ionogramme sanguin (Na, K, Cl, HCO3-)" },
        { cat: "Examens de base (bilan standard)", exam: "Cr√©atinine" },
        { cat: "Examens de base (bilan standard)", exam: "DFG estim√© (CKD-EPI)" },
        { cat: "Examens de base (bilan standard)", exam: "Glyc√©mie √† jeun" }
      ]
    },
    thyroide: {
      name: "Thyro√Øde",
      exams: [
        { cat: "Endocrinologie / M√©tabolisme", exam: "TSH" },
        { cat: "Endocrinologie / M√©tabolisme", exam: "T3 libre" },
        { cat: "Endocrinologie / M√©tabolisme", exam: "T4 libre" }
      ]
    },
    anemie: {
      name: "An√©mie",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "NFS" },
        { cat: "H√©matologie", exam: "R√©ticulocytes" },
        { cat: "H√©matologie", exam: "Ferritine" },
        { cat: "H√©matologie", exam: "Fer s√©rique" },
        { cat: "Vitamines / Min√©raux", exam: "Vitamine B12" },
        { cat: "Vitamines / Min√©raux", exam: "Folates" }
      ]
    },
    nutrition_parenterale: {
      name: "Nutrition parent√©rale",
      exams: [
        { cat: "Examens de base (bilan standard)", exam: "Albumine" },
        { cat: "Examens de base (bilan standard)", exam: "Pr√©albumine" },
        { cat: "Examens de base (bilan standard)", exam: "Ionogramme sanguin (Na, K, Cl, HCO3-)" },
        { cat: "Vitamines / Min√©raux", exam: "Magn√©s√©mie" },
        { cat: "Vitamines / Min√©raux", exam: "Calc√©mie" },
        { cat: "Vitamines / Min√©raux", exam: "Phosphor√©mie" },
        { cat: "Examens de base (bilan standard)", exam: "Cr√©atinine" },
        { cat: "Examens de base (bilan standard)", exam: "DFG estim√© (CKD-EPI)" },
        { cat: "Cardiologie / Vasculaire", exam: "Triglyc√©rides" },
        { cat: "Examens de base (bilan standard)", exam: "Bilan h√©patique (ASAT, ALAT, PAL, GGT, bilirubine)" }
      ]
    }
  };

  // ============================================================
  // √âTAT ‚Äî deux compartiments distincts
  // packages : [{ id, name, exams:[string,...] }, ...]  ‚Üí liste plate
  // individual : { categorie: [exam,...] }              ‚Üí par cat√©gorie
  // ============================================================
  const basket = {
    packages: [],   // blocs synth√©tiques (bilans g√©n√©riques + packages pathologies)
    individual: {}  // examens isol√©s ajout√©s via recherche / accord√©on / custom
  };

  const examIndex = {};
  Object.keys(CATALOG).forEach(cat => {
    CATALOG[cat].forEach(exam => {
      const key = exam.toLowerCase();
      if (!examIndex[key]) examIndex[key] = { name: exam, category: cat };
    });
  });

  function totalCount() {
    const pkgCount = basket.packages.reduce((s, p) => s + p.exams.length, 0);
    const indCount = Object.values(basket.individual).reduce((s, a) => s + a.length, 0);
    return pkgCount + indCount;
  }

  // ============================================================
  // BUILD UI
  // ============================================================
  function buildPickButtons(container, items, cssClass) {
    Object.entries(items).forEach(([id, profile]) => {
      const btn = document.createElement('button');
      btn.className = `pick-btn ${cssClass}`;
      btn.dataset.id = id;
      btn.innerHTML = `
        <span>${profile.name}</span>
        <span class="pick-count">${profile.exams.length} ex.</span>
      `;
      btn.onclick = () => applyProfile(btn, id, profile);
      container.appendChild(btn);
    });
  }

  function applyProfile(btn, id, profile) {
    // V√©rifier si ce package est d√©j√† dans le panier
    const exists = basket.packages.find(p => p.id === id);
    if (!exists) {
      basket.packages.push({
        id,
        name: profile.name,
        exams: profile.exams.map(e => e.exam)
      });
    }
    updateBasket();

    btn.classList.add('added');
    const orig = btn.innerHTML;
    btn.innerHTML = `<span>‚úì Ajout√© !</span><span class="pick-count">${profile.exams.length} ex.</span>`;
    setTimeout(() => {
      btn.innerHTML = orig;
      btn.classList.remove('added');
    }, 1600);
  }

  function buildAccordion() {
    const accordion = el('accordion');
    Object.keys(CATALOG).forEach((category, idx) => {
      const item = document.createElement('div');
      item.className = 'accordion-item';

      const header = document.createElement('div');
      header.className = 'accordion-header';
      header.innerHTML = `<span>${category}</span><span class="accordion-icon">‚ñº</span>`;

      const content = document.createElement('div');
      content.className = 'accordion-content';

      const body = document.createElement('div');
      body.className = 'accordion-body';

      const actions = document.createElement('div');
      actions.className = 'cat-actions';
      const selAll = document.createElement('button');
      selAll.textContent = 'Tout s√©lectionner';
      const clrAll = document.createElement('button');
      clrAll.textContent = 'Tout effacer';
      actions.appendChild(selAll);
      actions.appendChild(clrAll);

      const examList = document.createElement('div');
      examList.className = 'exam-list';

      CATALOG[category].forEach(exam => {
        const examItem = document.createElement('div');
        examItem.className = 'exam-item';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = `exam_${idx}_${exam}`;
        cb.dataset.category = category;
        cb.dataset.exam = exam;
        cb.onchange = () => handleCheck(category, exam, cb.checked);
        const lbl = document.createElement('label');
        lbl.htmlFor = cb.id;
        lbl.textContent = exam;
        examItem.appendChild(cb);
        examItem.appendChild(lbl);
        examList.appendChild(examItem);
      });

      selAll.onclick = () => examList.querySelectorAll('input').forEach(cb => { if (!cb.checked) { cb.checked = true; handleCheck(category, cb.dataset.exam, true); } });
      clrAll.onclick = () => examList.querySelectorAll('input').forEach(cb => { if (cb.checked) { cb.checked = false; handleCheck(category, cb.dataset.exam, false); } });
      header.onclick = () => {
        const isActive = header.classList.contains('active');
        document.querySelectorAll('.accordion-header').forEach(h => h.classList.remove('active'));
        document.querySelectorAll('.accordion-content').forEach(c => c.classList.remove('active'));
        if (!isActive) { header.classList.add('active'); content.classList.add('active'); }
      };

      body.appendChild(actions);
      body.appendChild(examList);
      content.appendChild(body);
      item.appendChild(header);
      item.appendChild(content);
      accordion.appendChild(item);
    });
  }

  function populateCategories() {
    const select = el('customExamCategory');
    Object.keys(CATALOG).forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      select.appendChild(opt);
    });
  }

  // ============================================================
  // PANIER ‚Äî examens individuels (accord√©on / recherche / custom)
  // ============================================================
  function handleCheck(category, exam, checked) {
    if (checked) {
      if (!basket.individual[category]) basket.individual[category] = [];
      if (!basket.individual[category].includes(exam)) basket.individual[category].push(exam);
    } else {
      if (basket.individual[category]) {
        basket.individual[category] = basket.individual[category].filter(e => e !== exam);
        if (!basket.individual[category].length) delete basket.individual[category];
      }
    }
    updateBasket();
  }

  function removePackage(id) {
    basket.packages = basket.packages.filter(p => p.id !== id);
    updateBasket();
  }

  function removePackageExam(pkgId, exam) {
    const pkg = basket.packages.find(p => p.id === pkgId);
    if (!pkg) return;
    pkg.exams = pkg.exams.filter(e => e !== exam);
    if (!pkg.exams.length) basket.packages = basket.packages.filter(p => p.id !== pkgId);
    updateBasket();
  }

  function removeIndividual(category, exam) {
    if (basket.individual[category]) {
      basket.individual[category] = basket.individual[category].filter(e => e !== exam);
      if (!basket.individual[category].length) delete basket.individual[category];
    }
    const cb = document.querySelector(`input[data-category="${category}"][data-exam="${exam}"]`);
    if (cb) cb.checked = false;
    updateBasket();
  }

  // Calcule l'ensemble des examens en doublon (pr√©sents dans 2+ blocs)
  function getDuplicates() {
    const seen = {};
    const dupes = new Set();
    // Packages
    basket.packages.forEach(pkg => {
      pkg.exams.forEach(exam => {
        const key = exam.toLowerCase();
        if (seen[key]) dupes.add(key);
        seen[key] = true;
      });
    });
    // Individuels
    Object.values(basket.individual).forEach(exams => {
      exams.forEach(exam => {
        const key = exam.toLowerCase();
        if (seen[key]) dupes.add(key);
        seen[key] = true;
      });
    });
    return dupes;
  }

  function updateBasket() {
    const total = totalCount();
    el('basketCounter').textContent = total;

    if (total === 0) {
      el('basketItems').innerHTML = `
        <div class="basket-empty">
          <span class="empty-icon">üß™</span>
          Aucun examen s√©lectionn√©.<br>Utilisez les bilans ou packages ci-contre.
        </div>`;
      return;
    }

    const dupes = getDuplicates();
    let html = '';

    // ‚Äî Packages (blocs synth√©tiques) ‚Äî suppression unitaire par examen
    basket.packages.forEach(pkg => {
      html += `
        <div class="basket-group">
          <div class="basket-group-title" style="display:flex;justify-content:space-between;align-items:center;">
            <span>${pkg.name}</span>
            <button class="basket-exam-remove" data-pkg="${pkg.id}" title="Retirer tout le bilan" style="font-size:10pt;opacity:0.6;">‚úï tout</button>
          </div>`;
      pkg.exams.forEach(exam => {
        const isDupe = dupes.has(exam.toLowerCase());
        html += `
          <div class="basket-exam${isDupe ? ' duplicate' : ''}">
            ${isDupe ? '<span class="duplicate-badge">doublon</span>' : ''}
            <span class="basket-exam-name">${exam}</span>
            <button class="basket-exam-remove" data-pkg-exam="${pkg.id}" data-exam="${exam}" title="Retirer cet examen">‚úï</button>
          </div>`;
      });
      html += `</div>`;
    });

    // ‚Äî Examens individuels
    const indKeys = Object.keys(basket.individual).sort();
    if (indKeys.length) {
      html += `<div class="basket-group"><div class="basket-group-title" style="color:#6b7280;background:#f3f4f6;">Examens individuels</div>`;
      indKeys.forEach(cat => {
        basket.individual[cat].forEach(exam => {
          const isDupe = dupes.has(exam.toLowerCase());
          html += `
            <div class="basket-exam${isDupe ? ' duplicate' : ''}">
              ${isDupe ? '<span class="duplicate-badge">doublon</span>' : ''}
              <span class="basket-exam-name">${exam}</span>
              <button class="basket-exam-remove" data-category="${cat}" data-exam="${exam}" title="Retirer">‚úï</button>
            </div>`;
        });
      });
      html += `</div>`;
    }

    el('basketItems').innerHTML = html;

    // Suppression bloc entier
    el('basketItems').querySelectorAll('[data-pkg]:not([data-exam])').forEach(btn => {
      btn.onclick = () => removePackage(btn.dataset.pkg);
    });
    // Suppression examen unitaire dans un package
    el('basketItems').querySelectorAll('[data-pkg-exam]').forEach(btn => {
      btn.onclick = () => removePackageExam(btn.dataset.pkgExam, btn.dataset.exam);
    });
    // Suppression examens individuels
    el('basketItems').querySelectorAll('[data-category]').forEach(btn => {
      btn.onclick = () => removeIndividual(btn.dataset.category, btn.dataset.exam);
    });
  }

  // ============================================================
  // RECHERCHE
  // ============================================================
  el('globalSearch').addEventListener('input', function () {
    const q = this.value.trim().toLowerCase();
    const resultsEl = el('searchResults');
    if (q.length < 2) { resultsEl.style.display = 'none'; return; }

    const results = Object.values(examIndex).filter(i => i.name.toLowerCase().includes(q));
    if (!results.length) {
      resultsEl.innerHTML = '<div class="no-results">Aucun examen trouv√©</div>';
      resultsEl.style.display = 'block';
      return;
    }
    resultsEl.innerHTML = results.map(i =>
      `<div class="search-result-item" data-exam="${i.name}" data-category="${i.category}">
        <span class="search-result-name">${i.name}</span>
        <span class="search-result-cat">${i.category}</span>
      </div>`
    ).join('');
    resultsEl.style.display = 'block';

    resultsEl.querySelectorAll('.search-result-item').forEach(item => {
      item.onclick = () => {
        const cat = item.dataset.category;
        const exam = item.dataset.exam;
        if (!basket.individual[cat]) basket.individual[cat] = [];
        if (!basket.individual[cat].includes(exam)) basket.individual[cat].push(exam);
        const cb = document.querySelector(`input[data-category="${cat}"][data-exam="${exam}"]`);
        if (cb) cb.checked = true;
        updateBasket();
        el('globalSearch').value = '';
        resultsEl.style.display = 'none';
      };
    });
  });

  // ============================================================
  // EXAMEN PERSONNALIS√â
  // ============================================================
  el('addCustomExam').onclick = () => {
    const name = el('customExamName').value.trim();
    const cat = el('customExamCategory').value;
    if (!name) { alert("Veuillez saisir le nom de l'examen."); return; }
    if (!cat) { alert('Veuillez choisir une cat√©gorie.'); return; }
    if (!basket.individual[cat]) basket.individual[cat] = [];
    if (!basket.individual[cat].includes(name)) basket.individual[cat].push(name);
    updateBasket();
    el('customExamName').value = '';
    el('customExamCategory').value = '';
    const btn = el('addCustomExam');
    btn.textContent = '‚úì Ajout√© !';
    btn.style.background = '#059669';
    setTimeout(() => { btn.textContent = 'Ajouter au panier'; btn.style.background = ''; }, 1500);
  };

  // ============================================================
  // G√âN√âRATION TEXTE
  // ============================================================
  function generateText() {
    const total = totalCount();
    if (!total) { alert('Veuillez s√©lectionner au moins un examen.'); return null; }

    const htmlParts = [], txtParts = [];

    // ‚Äî Packages ‚Üí liste plate sous le nom du bilan
    basket.packages.forEach(pkg => {
      htmlParts.push(
        `<strong>${pkg.name.toUpperCase()}</strong><br>` +
        pkg.exams.map(e => `&nbsp;&nbsp;${e}`).join('<br>')
      );
      txtParts.push(
        pkg.name.toUpperCase() + '\n' +
        pkg.exams.map(e => `  ${e}`).join('\n')
      );
    });

    // ‚Äî Examens individuels ‚Üí regroup√©s par cat√©gorie
    const indKeys = Object.keys(basket.individual).sort();
    indKeys.forEach(cat => {
      if (!basket.individual[cat].length) return;
      htmlParts.push(
        `<strong>${cat.toUpperCase()}</strong><br>` +
        basket.individual[cat].map(e => `&nbsp;&nbsp;${e}`).join('<br>')
      );
      txtParts.push(
        cat.toUpperCase() + '\n' +
        basket.individual[cat].map(e => `  ${e}`).join('\n')
      );
    });

    const intro = 'Pratiquer par IDE √† domicile, pr√©l√®vement pour dosage en LAM';
    return {
      html: intro + '<br><br>' + htmlParts.join('<br><br>'),
      txt:  intro + '\n\n'    + txtParts.join('\n\n')
    };
  }

  el('generate').onclick = () => {
    const result = generateText();
    if (!result) return;
    el('preview').innerHTML = result.html;
    el('richSource').innerHTML = result.html;
    // plain sera calcul√© depuis le contenu √©dit√© au moment de la copie
    el('previewSection').style.display = 'block';
    el('previewSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  el('copy').onclick = function () {
    const preview = el('preview');
    if (!preview.innerHTML.trim()) { alert("G√©n√©rez le texte d'abord."); return; }
    // Extraire le texte brut depuis le contenu √©dit√©
    const plainText = preview.innerText;
    navigator.clipboard?.writeText(plainText).then(() => {
      this.textContent = 'Copi√© ‚úÖ';
      setTimeout(() => this.textContent = 'Copier (texte brut)', 1400);
    }).catch(() => {
      // fallback
      const t = el('plain');
      t.value = plainText;
      t.focus(); t.select();
      document.execCommand('copy');
      this.textContent = 'Copi√© ‚úÖ';
      setTimeout(() => this.textContent = 'Copier (texte brut)', 1400);
    });
  };

  el('copyRich').onclick = function () {
    const preview = el('preview');
    if (!preview.innerHTML.trim()) { alert("G√©n√©rez le texte d'abord."); return; }
    // Synchroniser richSource avec le contenu √©dit√©
    el('richSource').innerHTML = preview.innerHTML;
    const src = el('richSource');
    const range = document.createRange();
    range.selectNodeContents(src);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    const ok = document.execCommand('copy');
    sel.removeAllRanges();
    this.textContent = ok ? 'Copi√© ‚úÖ' : 'R√©essayer';
    setTimeout(() => this.textContent = 'Copier avec mise en forme', 1400);
  };

  el('clearBasket').onclick = () => {
    if (!basket.packages.length && !Object.keys(basket.individual).length) return;
    if (!confirm('Vider le panier ?')) return;
    basket.packages = [];
    Object.keys(basket.individual).forEach(k => delete basket.individual[k]);
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    el('preview').innerHTML = '';
    el('plain').value = '';
    el('previewSection').style.display = 'none';
    updateBasket();
  };

  // ============================================================
  // TOGGLE SECTION AVANC√âE
  // ============================================================
  el('advancedToggle').onclick = function () {
    this.classList.toggle('open');
    el('advancedPanel').classList.toggle('open');
  };

  // ============================================================
  // INIT
  // ============================================================
  buildPickButtons(el('genericsList'), GENERICS, 'generic');
  buildPickButtons(el('pathosList'), PATHOS, 'patho');
  buildAccordion();
  populateCategories();
  updateBasket();

})();
</script>
</body>
</html>
